
    
    
#include "p16f887.inc"


 __CONFIG _CONFIG1, _FOSC_INTRC_NOCLKOUT & _WDTE_OFF & _PWRTE_OFF & _MCLRE_OFF & _CP_OFF & _CPD_OFF & _BOREN_OFF & _IESO_OFF & _FCMEN_OFF & _LVP_OFF

 __CONFIG _CONFIG2, _BOR4V_BOR40V & _WRT_OFF

GPR_VAR        UDATA	    
    TEMP	RES	1
    STAT	RES	1
    LECTURAADC1	RES	1
    LECTURAADC2	RES	1
    LECTURAADC3	RES	1
    LECTURAADC4	RES	1
    CUAL	RES	1
    
	
RES_VECT  CODE    0x0000            ; processor reset vector
    GOTO    SETUP                   ; go to beginning of program

 

ISR_VECT    CODE    0x0004

PUSH:
    MOVWF   TEMP		    ;PUSH
    SWAPF   STATUS,W
    MOVWF   STAT
    
    BCF	    STATUS,RP0
    BCF	    STATUS,RP1
    MOVF    ADRESH,W ;MUEVE A W EL RESULTADO DE CONVERSION
    BTFSC   CUAL, 0
    CALL    CARGARVARIABLE1
    BTFSC   CUAL, 3
    CALL    CARGARVARIABLE2
    BTFSC   CUAL, 2
    CALL    CARGARVARIABLE3
    BTFSC   CUAL, 1
    CALL    CARGARVARIABLE4
    BCF	    PIR1,ADIF ;BORRA LA BANDERA
    BCF	    ADCON0,ADON ;APAGA AL ADC  
 
POP: 
    SWAPF   STAT,W		    ;POP
    MOVWF   STATUS
    SWAPF   TEMP,F
    SWAPF   TEMP,W
    RETFIE
    
    
MAIN_PROG CODE
 


SETUP
   BSF	    STATUS,RP0		
   BCF	    STATUS,RP1
   MOVLW    b'00000111'		
   MOVWF    OSCCON
   MOVLW    D'0' ;JUSTIFICADO A LA IZQUIERDA
   MOVWF    ADCON1 ;ESTO JUSTIFICA PARA QUE LA CONVERSION LLENE A ADRESH
   BSF	    TRISA,0 ;ACA ESTA LA ENTRADA DEL POTENCIOMETRO
   BSF	    TRISA,1 ;ACA ESTA LA ENTRADA DEL POTENCIOMETRO
   BSF	    TRISA,2 ;ACA ESTA LA ENTRADA DEL POTENCIOMETRO
   BSF	    TRISA,3 ;ACA ESTA LA ENTRADA DEL POTENCIOMETRO
   CLRF	    TRISB
   CLRF	    PORTB
   MOVLW    b'01000000' ;INTERRUPCION ASOCIADA A LA CONVERSION ADC
   MOVWF    PIE1
   MOVLW    b'10000000'	
   MOVWF    OPTION_REG ;PRESCALER TIMER0 A 1 A 256
   BSF	    STATUS,RP1	
   BSF	    ANSEL,0   ;EL POTENCIOMETRO SE CONECTA AL BIT RA0
   BSF	    ANSEL,1   ;EL POTENCIOMETRO SE CONECTA AL BIT RA0
   BSF	    ANSEL,2   ;EL POTENCIOMETRO SE CONECTA AL BIT RA0
   BSF	    ANSEL,3   ;EL POTENCIOMETRO SE CONECTA AL BIT RA0
   BCF	    STATUS,RP0		
   BCF	    STATUS,RP1
   CALL	    CONFIGTIMER
   MOVLW    b'00000000' ;SELECCION DEL PUERTO RA1 COMO ENTRADA CONTINUA EN EL TIEMPO
   MOVWF    ADCON0
   MOVLW    D'0'
   MOVWF    ADRESH
   MOVWF    ADRESL
   MOVLW    b'11000000' ;PERMITE QUE EL ADC PUEDA INTERRUMPIR
   MOVWF    INTCON
   MOVLW    b'11000000' ;PERMITE QUE EL ADC PUEDA INTERRUMPIR
   MOVWF    PIR1
   CALL	    CONFIGURARPWM
   CLRF	    STAT
   CLRF	    TEMP
   CLRF	    LECTURAADC1
   CLRF	    LECTURAADC2
   CLRF	    LECTURAADC3
   CLRF	    LECTURAADC4
   CLRF	    CUAL
   BSF	    CUAL, 0
    
LOOP:
    BSF	    ADCON0,ADON ;PRENDE EL ADC
    CALL    ESPERA ;ESPERA EL TIEMPO NECESARIO PARA QUE LA CONVERSION SE TERMINE
    BSF	    ADCON0,1 ;EMPIEZA LA CONVERSION
    CALL    ACTUALIZARVARIABLES
    GOTO    LOOP  
    
CARGARVARIABLE1
    MOVF    ADRESH, W
    MOVWF   LECTURAADC1
    BSF	    ADCON0, 2  ;SET CHANNEL 1
    MOVLW   B'00001000'
    MOVWF   CUAL
    RETURN
    
CARGARVARIABLE2
    MOVF    ADRESH, W
    MOVWF   LECTURAADC2
    BCF	    ADCON0, 2 ;SET CHANNEL 2
    BSF	    ADCON0, 3 ;SET CHANNEL 2
    MOVLW   B'00000100'
    MOVWF   CUAL
    RETURN
    
CARGARVARIABLE3
    MOVF    ADRESH, W
    MOVWF   LECTURAADC3
    BSF	    ADCON0, 2 ;SET CHANNEL 3
    BSF	    ADCON0, 3 ;SET CHANNEL 3
    MOVLW   B'00000010'
    MOVWF   CUAL
    RETURN
    
CARGARVARIABLE4
    MOVF    ADRESH, W
    MOVWF   LECTURAADC4
    BCF	    ADCON0, 2 ;SET CHANNEL 4
    BCF	    ADCON0, 3 ;SET CHANNEL 4
    BSF	    ADCON0, 4 ;SET CHANNEL 4
    MOVLW   B'00000001'
    MOVWF   CUAL
    RETURN
    
ACTUALIZARVARIABLES
    BCF	    STATUS,RP0
    BCF	    STATUS,RP1
    MOVF    LECTURAADC1, W
    MOVWF   CCPR1L
    MOVF    LECTURAADC2, W
    MOVWF   CCPR2L
    MOVF    LECTURAADC3, W
    MOVWF   PORTB
    ;MOVF    LECTURAADC4, W
    ;MOVWF   PORTB
    RETURN


ESPERA
    ESPERARBANDERA:			
	BTFSS   INTCON,T0IF	;ESPERA QUE EL TIMER0 TENGA UN OVERFLOW
	GOTO    ESPERARBANDERA
	CALL    CONFIGTIMER	;RECONFIGURA EL TIMER0
    RETURN
   
CONFIGTIMER		   
    MOVLW   .20
    MOVWF   TMR0
    BCF	    INTCON,T0IF
    RETURN
    
CONFIGURARPWM
    BSF	    STATUS,RP0
    BCF	    STATUS,RP1
    BSF	    TRISC,RC2	 
    BSF	    TRISC,RC1	
    MOVLW   D'255'	
    MOVWF   PR2
    BCF	    STATUS,RP0
    BCF	    STATUS,RP1
    MOVLW   B'00001100'
    MOVWF   CCP1CON
    MOVLW   B'10000000'
    MOVWF   CCPR1L
    MOVLW   B'00001100'
    MOVWF   CCP2CON
    MOVLW   B'10000000'
    MOVWF   CCPR2L
    
TIMER2:
    BCF	    PIR1,TMR2IF
    BSF	    T2CON,T2CKPS0
    BSF	    T2CON,T2CKPS1
    BSF	    T2CON,TMR2ON
CHECKTIMER2:
    BTFSS   PIR1,TMR2IF
    GOTO    CHECKTIMER2
    BSF	    STATUS,RP0
    BCF	    STATUS,RP1
    BCF	    TRISC,RC2
    BCF	    TRISC,RC1
    RETURN
    
    
    END
